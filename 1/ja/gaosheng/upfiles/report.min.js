function Report(){this.init(),this.loading=new Loading}function Archives(){this.init()}function LatestPosts(){this.init()}function convertImgShortCode(text){return text.replace(/\[(jpg|png|gif):(\d+)?\]/g,"https://1376partners.com/upfiles/images/$2.$1")}Report.prototype.init=function(){this.api_url="//asunaro-app.sakura.ne.jp/apps/report/api/post.php",this.send_data={max:2,type:$("#articles").data("type"),report_type:$("#articles").data("report-type"),queries:{page:0,post_id:0}}},Report.prototype.fetchData=function(){var self=this;self.loading.disp(),self.setSendQueries(),self.jsonp=new GetJsonp,self.jsonp.setUrl(self.api_url),self.jsonp.setData(self.send_data),self.jsonp.send_params.error=function(){self.loading.close(),console.log("error")},location.href.match("post_id")?self.fetchDataSingle():self.fetchDataDefault(),self.jsonp.run()},Report.prototype.fetchDataDefault=function(){var self=this;self.send_data.subclass="Posts",self.jsonp.send_params.success=function(data_set){var datas=data_set.datas,count=data_set.count;self.loading.close(),(self.send_data.queries.words||self.send_data.queries.year)&&self.renderReportCondition(count),datas.length?self.renderDefault(datas,count):self.renderError()}},Report.prototype.renderDefault=function(datas,count){var paging;"voice"===this.send_data.type?this.renderVoice(datas):this.renderReport(datas),this.insertLinkElement(count),(new Paging).render(count,this.send_data.queries.page,this.send_data.max,$(".articles"))},Report.prototype.renderReport=function(datas){var $parent=$(".articles"),$article,$header,$posted,$icon,$title,$metas,$sub_title,$body;$.each(datas,function(i,data){$article=$("<article>").addClass("item"),$header=$("<div>").addClass("article-header"),$metas=$("<div>").addClass("metas cf"),$posted=$("<time>").addClass("posted").text(data.posted).attr("datetime",data.posted),$icon=$("<span>").addClass("icon icon-time-2"),$title=$("<p>").addClass("article-title").text(data.title),$sub_title=$("<h1>").addClass("sub-title").text(data.sub_title),$body=$("<div>").addClass("body").html(replaceLineFeed(convertImgShortCode(data.text))),$posted.prepend($icon),$metas.append($posted,$title),$header.append($metas,$sub_title),$article.append($header,$body),$parent.append($article)})},Report.prototype.renderReportCondition=function(count){var queries=this.send_data.queries,$p,$button,condition;queries.words?condition="検索ワード「"+this.getSearchWords()+"」":queries.year&&(condition="「"+queries.year+"年"+queries.month+"月"+queries.date+"日」"),condition=escapeHTML(condition),condition+=count>0?"の記事を表示中":"の記事は見つかりませんでした",$p=$("<p>").addClass("condition"),"0"===count&&$p.addClass("error"),$button=$("<button>").addClass("close-btn"),$p.append(condition,$button),$(".articles").before($p)},Report.prototype.renderVoice=function(datas){var self=this,$parent=$(".articles"),$ul,$li,$user,$admin,$figure,$img,$txt,$date,$title,$metas,$body;$ul=$("<ul>").addClass("voice-items"),$.each(datas,function(i,data){$li=$("<li>"),$user=$("<div>").addClass("user-area cf"),$figure=$("<figure>").append(self.getVoiceThumb(data.gender)),$txt=$("<div>").addClass("txt-group"),$date=$("<p>").addClass("date").text(data.posted),$title=$("<p>").addClass("title").text(data.title),$metas=self.getVoiceMetas(data),$body=$("<p>").addClass("body").html(replaceLineFeed(data.body)),$txt.append($date,$title,$metas,$body),$user.append($figure,$txt),$admin=$("<div>").addClass("admin-area cf"),$figure=$("<figure>"),$img=$("<img>").attr("src","/upfiles/pc-voice-thumb-admin.jpg"),$figure.append($img),$body=$("<p>").addClass("body").html(replaceLineFeed(data.comment)),$admin.append($figure,$body),$li.append($user,$admin),$ul.append($li)}),$parent.append($ul)},Report.prototype.getVoiceThumb=function(num){var src="/upfiles/pc-voice-thumb-",$img;return src+="1"===num?"male.gif":"2"===num?"female.gif":"unknown.gif",$("<img>").attr("src",src)},Report.prototype.getVoiceMetas=function(data){var metas=[],$metas,$li;return data.name?metas.push(data.name+" 様"):metas.push("匿名希望様"),"1"===data.gender?metas.push("男性"):"2"===data.gender&&metas.push("女性"),"0"!==data.age&&metas.push(data.age+"歳"),data.job&&metas.push(data.job),data.experience&&metas.push("投資歴："+data.experience),$metas=$("<ul>").addClass("metas cf"),$.each(metas,function(i,meta){$li=$("<li>").text(meta),$metas.append($li)}),$metas},Report.prototype.fetchDataSingle=function(){var self=this;self.send_data.subclass="Post",self.jsonp.send_params.success=function(data_set){self.loading.close(),data_set.current.length?self.renderSingle(data_set):self.renderError()}},Report.prototype.renderSingle=function(data_set){var current=data_set.current,prev=data_set.prev,next=data_set.next;this.renderReport(current),this.renderSinglePaging(prev,next),this.rewriteTitle(current[0].sub_title)},Report.prototype.renderSinglePaging=function(prev,next){var url,$paging,$prev,$next,$li;$paging=$("<ul>").addClass("paging-prev-next cf"),prev&&(url=getUrl()+"?post_id="+prev.id,url+=QRY_AD_CODE?"&"+QRY_AD_CODE:"",$li=$("<li>").addClass("paging-prev"),($prev=$("<a>").attr("href",url)).text(prev.sub_title),$li.append($prev),$paging.append($li),this.insertSingleLinkElement("prev",url)),next&&(url=getUrl()+"?post_id="+next.id,$li=$("<li>").addClass("paging-next"),($next=$("<a>").attr("href",url)).text(next.sub_title),$li.append($next),$paging.append($li),this.insertSingleLinkElement("next",url)),$(".articles").after($paging)},Report.prototype.insertSingleLinkElement=function(rel,href){var $link;$link=$("<link>").attr({rel:rel,href:href}),$("head").append($link)},Report.prototype.rewriteTitle=function(sub_title){$("title").text(sub_title+" | あすなろ投資顧問")},Report.prototype.setSendQueries=function(){var self=this,queries=getUrlQueries(),num;$.each(queries,function(key,value){"words"===key?self.send_data.queries.words=value.split("+"):"page"===key?(value=parseInt(value),num=!isFinite(value)||value<=0?1:value,self.send_data.queries.page=num-1):"post_id"===key?(value=parseInt(value),self.send_data.queries.post_id=!isFinite(value)||value<=0?1:value):self.send_data.queries[key]=value})},Report.prototype.setMax=function(max){this.send_data.max=max},Report.prototype.renderError=function(){var modal=new Modal;modal.init(),modal.renderNotification(["検索ワード「"+escapeHTML(this.getSearchWords())+"」の記事は見つかりませんでした"])},Report.prototype.insertLinkElement=function(count){var max,page,last,prev,next,url,$prev,$next;max=this.send_data.max,prev=(page=parseInt(this.send_data.queries.page,10)+1)-1,next=page+1,last=Math.ceil(count/this.send_data.max),url=getUrl(),$prev=$("<link>").attr({rel:"prev",href:url+"?page="+prev}),$next=$("<link>").attr({rel:"next",href:url+"?page="+next}),1===page?$("head").append($next):page===last?$("head").append($prev):$("head").append($prev,$next)},Report.prototype.getSearchWords=function(){var words="";return $.each(this.send_data.queries.words,function(i,word){words+=decodeURIComponent(word)+" "}),words.slice(0,-1)},$(function(){$("#report-search").click(function(){var $input,words=$('[name="report_search"]').val(),modal,query,redirect;if(words)return query=convertSearchWord(words),redirect=getUrl()+"?words="+query,window.location.href=redirect,!1;(modal=new Modal).init(),modal.renderError(["検索ワードを入力してください"])})}),Archives.prototype.init=function(){this.api_url="//asunaro-app.sakura.ne.jp/apps/report/api/",this.data_url=this.api_url+"archive.php",this.send_data={type:$("#articles").data("type"),report_type:$("#articles").data("report-type"),params:{year:"",month:""}},this.params=this.send_data.params,this.initDate()},Archives.prototype.initDate=function(){var year,month,now;now=new Date,year=getUrlQueries().year,month=getUrlQueries().month,year=year||now.getFullYear(),month=month||now.getMonth()+1,this.params.year=year,this.params.month=month},Archives.prototype.fetchData=function(year,month){var self=this;self.params.year=year||self.params.year,self.params.month=month||self.params.month;var jsonp=new GetJsonp;jsonp.setUrl(self.data_url),jsonp.setData(self.send_data),jsonp.send_params.success=function(data_set){self.render(data_set.dates,self.params.year,self.params.month)},jsonp.send_params.error=function(){console.log("error")},jsonp.run()},Archives.prototype.render=function(dates,year,month){var $table,$caption,$thead,$tbody;$table=$("<table>"),$caption=this.getCaption(year,month),$thead=this.getThead(),$tbody=this.getTbody(dates,year,month),$table.append($caption,$thead,$tbody),$(".archives .body").html($table)},Archives.prototype.getCaption=function(year,month){var $caption;return $("<caption>").text(year+"年 "+month+"月")},Archives.prototype.getThead=function(){var days=["日","月","火","水","木","金","土"],$thead,$tr,$th;return $thead=$("<thead>"),$tr=$("<tr>"),$.each(days,function(i,day){$th=$("<th>").text(day),0===i?$th.addClass("sun"):6===i&&$th.addClass("sat"),$tr.append($th)}),$thead.append($tr)},Archives.prototype.getTbody=function(dates,year,month){var first,first_day,last,last_date,last_day,td_start,td_end,out_loop_end,$tbody,$tr,$td,i,j,date;for(first_day=(first=new Date(year,month-1,1)).getDay(),last_date=(last=new Date(year,month,0)).getDate(),last_day=last.getDay(),td_start=0-first_day,out_loop_end=parseInt(((td_end=last_date+(6-last_day))-td_start)/7),$tbody=$("<tbody>"),i=0;i<out_loop_end;i++){for($tr=$("<tr>"),j=1;j<=7;j++)$td=(date=7*i+j+td_start)<1||date>last_date?$("<td>"):$("<td>").text(date),dates.indexOf(date)>-1&&$td.addClass("has-data"),$tr.append($td);$tbody.append($tr)}return $tbody},function(){var archives=new Archives,year,month,date;year=parseInt(archives.params.year,10),month=parseInt(archives.params.month,10),$(document).on("click",".archives-control-prev",function(){(month-=1)<1&&(year-=1,month=12),archives.fetchData(year,month)}),$(document).on("click",".archives-control-next",function(){(month+=1)>12&&(year+=1,month=1),archives.fetchData(year,month)}),$(document).on("click",".archives .has-data",function(){var query,redirect;return date=$(this).text(),query=buildUrlQuery({year:year,month:month,date:date}),redirect=getUrl()+"?"+query,redirect+=QRY_AD_CODE?"&"+QRY_AD_CODE:"",window.location.href=redirect,!1})}(),LatestPosts.prototype.init=function(){this.api_url="//asunaro-app.sakura.ne.jp/apps/report/api/",this.data_url=this.api_url+"latest.php",this.send_data={type:$("#articles").data("type"),report_type:$("#articles").data("report-type")}},LatestPosts.prototype.fetchData=function(){var self=this,jsonp=new GetJsonp;jsonp.setUrl(self.data_url),jsonp.setData(self.send_data),jsonp.send_params.success=function(data_set){self.render(data_set.data)},jsonp.send_params.error=function(){console.log("error")},jsonp.run()},LatestPosts.prototype.render=function(data){var $ul,$li,$a,$title,$posted,$newer;$ul=$(".report-latest-items"),$.each(data,function(i,obj){var url=getUrl()+"?post_id="+obj.id;url+=QRY_AD_CODE?"&"+QRY_AD_CODE:"",$li=$("<li>"),$a=$("<a>").attr("href",url).addClass("cf"),$title=$("<p>").addClass("title").text(obj.sub_title),$posted=$("<p>").addClass("posted").text("("+obj.posted+")"),$a.append($title,$posted),obj.newer&&($newer=$("<p>").addClass("new").text("new"),$a.append($newer)),$li.append($a),$ul.append($li)})},$(document).on("click",".reports .paging a, .voice .paging a",function(){var current,query;return(current=getUrlQueries()).page=parseInt($(this).attr("href"),10),query=buildUrlQuery(current),window.location.href=getUrl()+"?"+query,!1}),$(document).on("click",".reports .condition .close-btn",function(){var url=getUrl();return url+=QRY_AD_CODE?"?"+QRY_AD_CODE:"",window.location.href=url,!1}),$(document).keydown(function(e){13===e.keyCode&&$('[name="report_search"]:focus').length>0&&$("#report-search").click()});